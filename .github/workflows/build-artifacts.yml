name: Build cross-platform artifacts

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**/*.py'
      - 'backend/requirements*.txt'
      - 'backend/colorcorrector.spec'
      - 'frontend/src/**'
      - 'frontend/package.json'
      - 'frontend/package-lock.json'
      - '.github/workflows/build-artifacts.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    defaults:
      run:
        shell: bash
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    name: Build on ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /opt/hostedtoolcache/CodeQL || true
          sudo docker image prune --all --force || true
          df -h

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Build frontend
        run: |
          cd frontend
          npm ci
          npm run build

      - name: Copy frontend build into backend
        run: |
          rm -rf backend/frontend_dist || true
          mkdir -p backend
          if [ -d frontend/dist ]; then
            cp -r frontend/dist backend/frontend_dist
          else
            echo "Frontend build not found"; exit 1
          fi

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install backend requirements
        run: |
          python -m pip install --upgrade pip wheel setuptools
          # Use CPU-only requirements for Linux/macOS to avoid CUDA dependencies
          if [ "${{ runner.os }}" = "Windows" ]; then
            python -m pip install -r backend/requirements.txt --no-cache-dir
          else
            # Install torch first based on OS
            if [ "${{ runner.os }}" = "Linux" ]; then
              # Linux: CPU-only torch from PyTorch CPU index
              python -m pip install torch==2.5.1+cpu torchvision==0.20.1+cpu --index-url https://download.pytorch.org/whl/cpu --no-cache-dir
            else
              # macOS: regular torch (no CUDA builds available)
              python -m pip install torch torchvision --no-cache-dir
            fi
            # Install other requirements
            python -m pip install -r backend/requirements-no-torch.txt --no-cache-dir
            # Install ColorCorrectionPipeline without dependencies (deps already installed above)
            python -m pip install --no-deps ColorCorrectionPipeline --no-cache-dir
          fi

      - name: Clean pip cache after install
        run: |
          python -m pip cache purge
          df -h

      - name: Build backend with PyInstaller
        working-directory: backend
        run: |
          pyinstaller -y colorcorrector.spec
          echo "PyInstaller completed. Checking dist directory:"
          ls -lh dist/

      - name: Clean up build artifacts to save space
        working-directory: backend
        run: |
          rm -rf build/
          df -h

      - name: Package artifact
        if: success()
        shell: pwsh
        run: |
          $ArtDir = "backend/dist/ColorCorrector"
          $OutZip = "backend/artifact-${{ matrix.os }}.zip"
          if (Test-Path $ArtDir) {
            Compress-Archive -Path $ArtDir -DestinationPath $OutZip -Force
            Write-Host "Artifact created: $OutZip"
          } elseif (Test-Path "backend/dist/ColorCorrector.exe") {
            Compress-Archive -Path "backend/dist/ColorCorrector.exe" -DestinationPath $OutZip -Force
            Write-Host "Artifact created: $OutZip"
          } elseif (Test-Path "backend/dist") {
            Compress-Archive -Path "backend/dist/*" -DestinationPath $OutZip -Force
            Write-Host "Packaged backend/dist as artifact"
          } else {
            Write-Host "No backend/dist artifact found"
            Get-ChildItem backend -ErrorAction SilentlyContinue
            exit 1
          }

      - name: Rename artifact for release
        shell: pwsh
        run: |
          $OsName = "${{ matrix.os }}"
          if ($OsName -eq "windows-latest") { $OsLabel = "Windows" }
          elseif ($OsName -eq "macos-latest") { $OsLabel = "macOS" }
          elseif ($OsName -eq "ubuntu-latest") { $OsLabel = "Linux" }
          else { $OsLabel = $OsName }
          
          $InZip = "backend/artifact-${{ matrix.os }}.zip"
          $OutZip = "ColorCorrector-$OsLabel.zip"
          Move-Item -Path $InZip -Destination $OutZip -Force
          Write-Host "Renamed to: $OutZip"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ColorCorrector-${{ matrix.os }}
          path: ColorCorrector-*.zip

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Display structure
        run: |
          ls -R artifacts
      
      - name: Generate release tag and date
        id: tag
        run: |
          TAG="v$(date +'%Y.%m.%d')-build.${{ github.run_number }}"
          BUILD_DATE="$(date +'%Y-%m-%d %H:%M:%S UTC')"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "date=$BUILD_DATE" >> $GITHUB_OUTPUT
          echo "Release tag: $TAG"
          echo "Build date: $BUILD_DATE"
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Release ${{ steps.tag.outputs.tag }}
          body: |
            ## Color Correction Package UI - Automated Build
            
            **Built from commit:** ${{ github.sha }}
            **Build date:** ${{ steps.tag.outputs.date }}
            
            ### Downloads
            
            Download the appropriate version for your operating system:
            
            - **Windows**: `ColorCorrector-Windows.zip`
            - **macOS**: `ColorCorrector-macOS.zip`
            - **Linux**: `ColorCorrector-Linux.zip`
            
            ### Installation
            
            1. Download the appropriate zip file for your OS
            2. Extract the archive
            3. Run the `ColorCorrector` executable
            4. Open your browser to `http://localhost:5000`
            
            ### Changes in this build
            
            See commit history for details.
          files: |
            artifacts/ColorCorrector-windows-latest/ColorCorrector-Windows.zip
            artifacts/ColorCorrector-macos-latest/ColorCorrector-macOS.zip
            artifacts/ColorCorrector-ubuntu-latest/ColorCorrector-Linux.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
