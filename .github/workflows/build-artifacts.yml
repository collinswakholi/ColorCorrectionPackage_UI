name: Build cross-platform artifacts

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**/*.py'
      - 'backend/**/*.sh'
      - 'backend/**/*.bat'
      - 'backend/**/*.iss'
      - 'backend/requirements*.txt'
      - 'backend/colorcorrector.spec'
      - 'frontend/src/**'
      - 'frontend/package.json'
      - 'frontend/package-lock.json'
      - '.github/workflows/build-artifacts.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    defaults:
      run:
        shell: bash
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    name: Build on ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /opt/hostedtoolcache/CodeQL || true
          sudo docker image prune --all --force || true
          df -h

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Build frontend
        run: |
          cd frontend
          npm ci
          npm run build

      - name: Copy frontend build into backend
        run: |
          rm -rf backend/frontend_dist || true
          mkdir -p backend
          if [ -d frontend/dist ]; then
            cp -r frontend/dist backend/frontend_dist
          else
            echo "Frontend build not found"; exit 1
          fi

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install backend requirements
        run: |
          python -m pip install --upgrade pip wheel setuptools
          # Use CPU-only PyTorch for all platforms to avoid CUDA dependencies
          if [ "${{ runner.os }}" = "Linux" ]; then
            # Linux: CPU-only torch from PyTorch CPU index
            python -m pip install torch==2.5.1+cpu torchvision==0.20.1+cpu --index-url https://download.pytorch.org/whl/cpu --no-cache-dir
          elif [ "${{ runner.os }}" = "Windows" ]; then
            # Windows: CPU-only torch from PyTorch CPU index
            python -m pip install torch==2.5.1+cpu torchvision==0.20.1+cpu --index-url https://download.pytorch.org/whl/cpu --no-cache-dir
          else
            # macOS: regular torch (no CUDA builds available anyway)
            python -m pip install torch torchvision --no-cache-dir
          fi
          # Install other requirements (without torch)
          python -m pip install -r backend/requirements-no-torch.txt --no-cache-dir
          # Install ColorCorrectionPipeline without dependencies (deps already installed above)
          python -m pip install --no-deps ColorCorrectionPipeline --no-cache-dir

      - name: Clean pip cache after install
        run: |
          python -m pip cache purge
          df -h

      - name: Build backend with PyInstaller
        working-directory: backend
        run: |
          pyinstaller -y colorcorrector.spec
          echo "PyInstaller completed. Checking dist directory:"
          ls -lh dist/

      - name: Clean up build artifacts to save space
        working-directory: backend
        run: |
          rm -rf build/
          df -h

      - name: Create Windows Installer with Inno Setup
        if: runner.os == 'Windows'
        run: |
          echo "Installing Inno Setup..."
          choco install innosetup -y
          
          echo "Building Windows installer..."
          cd backend
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer-windows.iss
          
          echo "Installer created successfully"
          ls installer_output/
        shell: pwsh

      - name: Create macOS DMG
        if: runner.os == 'macOS'
        run: |
          echo "Creating macOS .app bundle and DMG..."
          cd backend
          chmod +x create-dmg.sh
          ./create-dmg.sh
          
          echo "DMG created successfully"
          ls -lh *.dmg

      - name: Create Linux AppImage
        if: runner.os == 'Linux'
        run: |
          echo "Creating Linux AppImage..."
          cd backend
          chmod +x create-appimage.sh
          ./create-appimage.sh
          
          echo "AppImage created successfully"
          ls -lh *.AppImage

      - name: Prepare artifacts for upload
        shell: bash
        run: |
          mkdir -p upload
          if [ "${{ runner.os }}" = "Windows" ]; then
            cp backend/installer_output/ColorCorrector-Setup-Windows.exe upload/
          elif [ "${{ runner.os }}" = "macOS" ]; then
            cp backend/ColorCorrector-macOS.dmg upload/
          elif [ "${{ runner.os }}" = "Linux" ]; then
            cp backend/ColorCorrector-Linux-x86_64.AppImage upload/
          fi
          ls -lh upload/

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ColorCorrector-${{ matrix.os }}
          path: upload/*

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Display structure
        run: |
          ls -R artifacts
      
      - name: Generate release tag and date
        id: tag
        run: |
          TAG="v$(date +'%Y.%m.%d')-build.${{ github.run_number }}"
          BUILD_DATE="$(date +'%Y-%m-%d %H:%M:%S UTC')"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "date=$BUILD_DATE" >> $GITHUB_OUTPUT
          echo "Release tag: $TAG"
          echo "Build date: $BUILD_DATE"
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Release ${{ steps.tag.outputs.tag }}
          body: |
            ## Color Correction Package UI - Automated Build
            
            **Built from commit:** ${{ github.sha }}
            **Build date:** ${{ steps.tag.outputs.date }}
            
            ### üì¶ Downloads
            
            Download the appropriate installer for your operating system:
            
            #### Windows
            - **`ColorCorrector-Setup-Windows.exe`** - Professional installer with Start Menu shortcuts
              - Double-click to install
              - No manual permissions needed
              - Creates desktop shortcut (optional)
            
            #### macOS
            - **`ColorCorrector-macOS.dmg`** - DMG installer with .app bundle
              - Open DMG and drag to Applications folder
              - First run: Right-click ‚Üí Open (unsigned app)
              - Launches browser automatically
            
            #### Linux
            - **`ColorCorrector-Linux-x86_64.AppImage`** - Universal Linux package
              - Make executable: `chmod +x ColorCorrector-Linux-x86_64.AppImage`
              - Run directly: `./ColorCorrector-Linux-x86_64.AppImage`
              - No installation required
            
            ### üöÄ Quick Start
            
            After installation:
            1. Launch ColorCorrector from your OS (Start Menu/Applications/terminal)
            2. The server starts automatically
            3. Browser opens to `http://localhost:5000`
            4. Upload images and perform color correction!
            
            ### üìù Changes in this build
            
            See commit history for details.
            
            ---
            
            **Note:** These installers are not code-signed. You may see security warnings on first run:
            - **Windows**: Click "More info" ‚Üí "Run anyway"
            - **macOS**: Right-click ‚Üí "Open" (first time only)
            - **Linux**: Make executable with `chmod +x`
          files: |
            artifacts/ColorCorrector-windows-latest/ColorCorrector-Setup-Windows.exe
            artifacts/ColorCorrector-macos-latest/ColorCorrector-macOS.dmg
            artifacts/ColorCorrector-ubuntu-latest/ColorCorrector-Linux-x86_64.AppImage
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
